<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Y86 Simulator</title>
        <link rel="stylesheet" type="text/css" href="./css/simulator.css" />
        <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
        <script language="javascript" src="./js/jquery.min.js"></script>
        <script language="javascript" src="./js/jquery-bganimate.min.js"></script>
        <script language="javascript" src="./js/FileSaver.js"></script>
        <script language="javascript" src="./js/constants.js"></script>
        <script language="javascript" src="./js/utils.js"></script>
        <script language="javascript" src="./js/memory.js"></script>
        <script language="javascript" src="./js/registers.js"></script>
        <script language="javascript" src="./js/kernel.js"></script>
        <script language="javascript" src="./js/controller.js"></script>
    </head>

    <body>
        <div id="drop_area" class="drop_area"></div>

        <div id="controller" class="header">
            <div id="status">Nothing Loaded.</div>
            <button id="prev">Prev</button>
            <button id="pause">Pause</button>
            <button id="start">Start</button>
            <button id="next">Next</button>
            <button id="reset">Reset</button>
            Frequency: <input type="text" maxlength="3" id="freq" size="5" value="50" /> Hz
            <input type="text" maxlength="10" placeholder="Mem Addr" id="mem_addr" size="15" />
        </div>

        <div id="blocks" class="arena">
            <div id="fetch" class="block fetch">
                <div id="fetch_title" class="block_title">Fetch</div>
                <div class="entry_block">
                    <div class="entry_title">predPC</div>
                    <div class="entry_content" id="F_predPC">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">STAT</div>
                    <div class="entry_content" id="stat">S_AOK</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">Cycles</div>
                    <div class="entry_content" id="cycle">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">Instructions</div>
                    <div class="entry_content" id="instruction">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valMem</div>
                    <div class="entry_content" id="mem_val">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">CPI</div>
                    <div class="entry_content" id="CPI">1.0</div>
                </div>
            </div>
            <div id="decode" class="block decode">
                <div id="decode_title" class="block_title">Decode</div>
                <div class="entry_block">
                    <div class="entry_title">stat</div>
                    <div class="entry_content" id="D_stat">S_AOK</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">icode</div>
                    <div class="entry_content" id="D_icode">I_NOP</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">ifun</div>
                    <div class="entry_content" id="D_ifun">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">rA</div>
                    <div class="entry_content" id="D_rA">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">rB</div>
                    <div class="entry_content" id="D_rB">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valC</div>
                    <div class="entry_content" id="D_valC">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valP</div>
                    <div class="entry_content" id="D_valP">0x00000000</div>
                </div>
            </div>
            <div id="execute" class="block execute">
                <div id="execute_title" class="block_title">Execute</div>
                <div class="entry_block">
                    <div class="entry_title">stat</div>
                    <div class="entry_content" id="E_stat">S_AOK</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">icode</div>
                    <div class="entry_content" id="E_icode">I_NOP</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">ifun</div>
                    <div class="entry_content" id="E_ifun">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valA</div>
                    <div class="entry_content" id="E_valA">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valB</div>
                    <div class="entry_content" id="E_valB">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valC</div>
                    <div class="entry_content" id="E_valC">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstE</div>
                    <div class="entry_content" id="E_dstE">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstM</div>
                    <div class="entry_content" id="E_dstM">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">srcA</div>
                    <div class="entry_content" id="E_srcA">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">srcB</div>
                    <div class="entry_content" id="E_srcB">R_NONE</div>
                </div>
            </div>
            <div id="memory" class="block memory">
                <div id="memory_title" class="block_title">Memory</div>
                <div class="entry_block">
                    <div class="entry_title">stat</div>
                    <div class="entry_content" id="M_stat">S_AOK</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">icode</div>
                    <div class="entry_content" id="M_icode">I_NOP</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">Bch</div>
                    <div class="entry_content" id="M_Bch">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valE</div>
                    <div class="entry_content" id="M_valE">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valA</div>
                    <div class="entry_content" id="M_valA">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstE</div>
                    <div class="entry_content" id="M_dstE">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstM</div>
                    <div class="entry_content" id="M_dstM">R_NONE</div>
                </div>
            </div>
            <div id="writeback" class="block write_back">
                <div id="writeback_title" class="block_title">Write back</div>
                <div class="entry_block">
                    <div class="entry_title">stat</div>
                    <div class="entry_content" id="W_stat">S_AOK</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">icode</div>
                    <div class="entry_content" id="W_icode">I_NOP</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valE</div>
                    <div class="entry_content" id="W_valE">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">valM</div>
                    <div class="entry_content" id="W_valM">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstE</div>
                    <div class="entry_content" id="W_dstE">R_NONE</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">dstM</div>
                    <div class="entry_content" id="W_dstM">R_NONE</div>
                </div>
            </div>
            <div id="monitor" class="block monitor">
                <div id="monitor_title" class="block_title">Registers</div>
                <div class="entry_block">
                    <div class="entry_title">%eax</div>
                    <div class="entry_content" id="R_EAX">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%ecx</div>
                    <div class="entry_content" id="R_ECX">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%edx</div>
                    <div class="entry_content" id="R_EDX">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%ebx</div>
                    <div class="entry_content" id="R_EBX">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%esp</div>
                    <div class="entry_content" id="R_ESP">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%ebp</div>
                    <div class="entry_content" id="R_EBP">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%esi</div>
                    <div class="entry_content" id="R_ESI">0x00000000</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">%edi</div>
                    <div class="entry_content" id="R_EDI">0x00000000</div>
                </div>
            </div>
            <div id="ccmonitor" class="block ccmonitor">
                <div id="ccmonitor_title" class="block_title">CC</div>
                <div class="entry_block">
                    <div class="entry_title">ZF</div>
                    <div class="entry_content" id="ZF">1</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">SF</div>
                    <div class="entry_content" id="SF">0</div>
                </div>
                <div class="entry_block">
                    <div class="entry_title">OF</div>
                    <div class="entry_content" id="OF">0</div>
                </div>
            </div>
        </div>

        <div>
            <div>
                Filename: <input type="text" id="save_filename" placeholder="filename" style="width: 100px" />.txt
                <button id="save">Save</button>
            </div>
        </div>

        <script language="javascript">
            var pre =$('#drop_area').html();
            console.log(pre);

            function _updateMem() {
                var num = parseInt($('#mem_addr').val());
                if(isNaN(num)) num = parseInt($('#mem_addr').val(), 16);
                if(isNaN(num)) { $('#mem_val').html('Invalid Addr'); return ; }
                $('#mem_val').html(toHexString(VM.M.readUnsigned(num)));
            }

            $('#mem_addr').change(function() {
                _updateMem();
            });

            $('#prev').click(function() {
                lastStep();
            });

            $('#next').click(function() {
                nextStep();
            });

            $('#start').click(function() {
                startTimer($('#freq').val());
            });

            $('#pause').click(function() {
                stopTimer();
            });

            $('#reset').click(function() {
                YOReload(true);
                _updateMem();
            });

            $('#save').click(function(){
                saveResult();
            });

            $(document).keydown(function(e) {
                if (e.keyCode == 37) lastStep(); // Left
                else if (e.keyCode == 39) nextStep(); // Right
                else if (e.keyCode == 13) startTimer($('#freq').val()); // Enter
                else if (e.keyCode == 82) YOReload(true); // R
                else return;
                e.preventDefault();
            }).keyup(function(e) {	_updateMem(); });

            $('html body').on(
                    'dragover',
                    function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
            ).on(
                    'dragenter',
                    function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        pre = $('#drop_area').html();
                        $('#drop_area').html("Drop to load :)");
                    }
            ).on(
                    'dragleave',
                    function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        $('#drop_area').html(pre);
                    }
            ).on(
                    'drop',
                    function(e) {
                        if (e.originalEvent.dataTransfer) {
                            if(e.originalEvent.dataTransfer.files.length) {
                                e.preventDefault();
                                e.stopPropagation();
                                var files = e.originalEvent.dataTransfer.files; // FileList object
                                var fHandle = files[0];

                                var reader = new FileReader();

                                reader.onloadend = function(event) {
                                    if(event.target.readyState == FileReader.DONE)
                                        YOLoader(event.target.result, fHandle.name);
                                };

                                reader.readAsText(fHandle);
                            }
                        }
                    }
            );

            function nextStep() {
                console.log('step');
                if(!YOLoaded) return YOReload();
                try {
                    VM.CPU.tick();
                }
                catch (e) {
                    window.alert("VM terminated by signal " + getStatName(e));
                    return false;
                }
                updateDisplay(VM.CPU.getInput());
                return true;
            }

            function lastStep() {
                if(!YOLoaded) return YOReload();
                var lastCycle = VM.CPU.getCycle() - 1;
                if(lastCycle < 0) return;
                YOReload();
                doStep(lastCycle);
            }

            function doStep(cycleNum) {
                for (var i = 0; i < cycleNum; ++ i) VM.CPU.tick();
                updateDisplay(VM.CPU.getInput());
            }

            window.startTimer = function(freq) {
                freq = parseFloat(freq);
                if (freq < 1e-8) alert("Invalid frequency!");
                if (freq > 999) alert("Too fast!");
                var delay = Math.round(1000 / freq);
                if(window.clockTimer) window.clearInterval(window.clockTimer);
                window.clockTimer = window.setInterval(function(){ if(!nextStep()) stopTimer();}, delay);
            };

            window.stopTimer = function() {
                if (window.clockTimer) window.clearInterval(window.clockTimer);
                window.clockTimer = undefined;
            }
        </script>
    </body>
</html>
